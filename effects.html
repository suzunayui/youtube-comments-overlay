<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<title>Fireworks Canvas</title>
<style>
  html, body {
    margin: 0;
    padding: 0;
    overflow: hidden;
    background: transparent;
  }
  canvas {
    display: block;
    background: transparent;
  }
</style>
</head>
<body>
<canvas id="fw-canvas"></canvas>

<script>
const FW_COLORS = ["#ff6b6b", "#ffd93d", "#6bcbff", "#ff9ff3", "#1dd1a1", "#feca57", "#54a0ff"];
const FW_SCALE = 2;
const SNOW_COUNT = 120;
const SPARKLE_COUNT = 40;
const SNOW_EMOJIS = ["â„", "â›„", "ğŸ„", "âœ»", "âœ¼", "*"];

let canvas, ctx;
let rockets = [];
let particles = [];
let snowParticles = [];
let snowInitialized = false;
let snowActiveUntil = 0;

class Rocket {
  constructor() {
    const w = canvas.width;
    const h = canvas.height;
    this.x = w * (0.1 + Math.random() * 0.8);
    this.y = h + 10;
    this.vx = (Math.random() - 0.5) * 1.2;
    this.vy = -(6 + Math.random() * 2.5);
    this.targetY = h * (0.18 + Math.random() * 0.25);
    this.color = FW_COLORS[(Math.random() * FW_COLORS.length) | 0];
    this.history = [];
    this.alive = true;
  }
  update() {
    this.history.push({ x: this.x, y: this.y });
    if (this.history.length > 12) this.history.shift();
    this.x += this.vx;
    this.y += this.vy;
    this.vy += 0.08;
    if (this.vy >= -0.5 || this.y <= this.targetY) {
      this.alive = false;
      multiBurst(this.x, this.y, this.color);
    }
  }
  draw() {
    ctx.lineWidth = 2 * FW_SCALE;
    for (let i = 0; i < this.history.length - 1; i++) {
      const p1 = this.history[i];
      const p2 = this.history[i + 1];
      const t = i / this.history.length;
      ctx.strokeStyle = `rgba(255,255,255,${0.2 + t * 0.6})`;
      ctx.beginPath();
      ctx.moveTo(p1.x, p1.y);
      ctx.lineTo(p2.x, p2.y);
      ctx.stroke();
    }
    ctx.fillStyle = "#fff";
    ctx.beginPath();
    ctx.arc(this.x, this.y, 2.5 * FW_SCALE, 0, Math.PI * 2);
    ctx.fill();
  }
}

class Particle {
  constructor(x, y, color, size, speed, angle, life, sparkle) {
    this.x = x;
    this.y = y;
    this.vx = Math.cos(angle) * speed;
    this.vy = Math.sin(angle) * speed;
    this.friction = 0.985;
    this.gravity = 0.06 + Math.random() * 0.04;
    this.size = size;
    this.life = life;
    this.maxLife = life;
    this.color = color;
    this.sparkle = sparkle;
  }
  update() {
    this.vx *= this.friction;
    this.vy *= this.friction;
    this.vy += this.gravity;
    this.x += this.vx;
    this.y += this.vy;
    this.life--;
  }
  draw() {
    const t = this.life / this.maxLife;
    if (t <= 0) return;
    let alpha = t;
    if (this.sparkle && (this.life % 5 < 2)) alpha *= 0.35;
    ctx.globalAlpha = alpha;
    ctx.fillStyle = this.color;
    ctx.beginPath();
    ctx.arc(this.x, this.y, this.size * (0.6 + t), 0, Math.PI * 2);
    ctx.fill();
    ctx.globalAlpha = alpha * 0.6;
    ctx.beginPath();
    ctx.arc(this.x, this.y, this.size * 2.5 * t, 0, Math.PI * 2);
    ctx.fill();
    ctx.globalAlpha = 1;
  }
  get alive() {
    return this.life > 0;
  }
}

function createSnow(x, y) {
  return {
    type: "snow",
    x,
    y,
    r: 3 + Math.random() * 4,
    vy: 0.5 + Math.random() * 1.2,
    vx: -0.4 + Math.random() * 0.8,
    alpha: 0.5 + Math.random() * 0.5,
    twinkleSpeed: 0.002 + Math.random() * 0.003,
    twinkleOffset: Math.random() * Math.PI * 2,
  };
}

function createSparkle(x, y) {
  return {
    type: "sparkle",
    x,
    y,
    r: 2.5 + Math.random() * 2.5,
    vy: 0.3 + Math.random() * 0.8,
    vx: -0.3 + Math.random() * 0.6,
    alpha: 0.6 + Math.random() * 0.4,
    twinkleSpeed: 0.004 + Math.random() * 0.004,
    twinkleOffset: Math.random() * Math.PI * 2,
  };
}

function hexToHsl(hex) {
  hex = hex.replace("#", "");
  if (hex.length === 3) hex = hex.split("").map((c) => c + c).join("");
  const r = parseInt(hex.substr(0, 2), 16) / 255;
  const g = parseInt(hex.substr(2, 2), 16) / 255;
  const b = parseInt(hex.substr(4, 2), 16) / 255;
  const max = Math.max(r, g, b), min = Math.min(r, g, b);
  let h, s, l = (max + min) / 2;
  if (max === min) {
    h = s = 0;
  } else {
    const d = max - min;
    s = l > 0.5 ? d / (2 - max - min) : d / (max + min);
    switch (max) {
      case r: h = (g - b) / d + (g < b ? 6 : 0); break;
      case g: h = (b - r) / d + 2; break;
      case b: h = (r - g) / d + 4; break;
    }
    h *= 60;
  }
  return { h, s: s * 100, l: l * 100 };
}

function createSnow(x, y) {
  return {
    type: "snow",
    x,
    y,
    r: 2 + Math.random() * 3,
    vy: 0.5 + Math.random() * 1.2,
    vx: -0.4 + Math.random() * 0.8,
    alpha: 0.5 + Math.random() * 0.5,
    twinkleSpeed: 0.002 + Math.random() * 0.003,
    twinkleOffset: Math.random() * Math.PI * 2,
  };
}

function createSparkle(x, y) {
  return {
    type: "sparkle",
    x,
    y,
    r: 1.5 + Math.random() * 2,
    vy: 0.3 + Math.random() * 0.8,
    vx: -0.3 + Math.random() * 0.6,
    alpha: 0.6 + Math.random() * 0.4,
    twinkleSpeed: 0.004 + Math.random() * 0.004,
    twinkleOffset: Math.random() * Math.PI * 2,
  };
}

function burst(x, y, baseColor, count, baseSpeed, scale) {
  for (let i = 0; i < count; i++) {
    const angle = Math.random() * Math.PI * 2;
    const speed = baseSpeed * (0.5 + Math.random()) * FW_SCALE;
    const size = (1.8 * scale + Math.random() * 1.5 * scale) * FW_SCALE;
    const c = hexToHsl(baseColor);
    const h = (c.h + (Math.random() * 40 - 20) + 360) % 360;
    const s = Math.min(100, c.s + (Math.random() * 20 - 10));
    const l = Math.min(70, c.l + (Math.random() * 10 - 5));
    const color = `hsl(${h},${s}%,${l}%)`;
    const life = 50 + Math.random() * 40;
    const sparkle = Math.random() < 0.7;
    particles.push(new Particle(x, y, color, size, speed, angle, life, sparkle));
  }
}

function multiBurst(x, y, baseColor) {
  burst(x, y, baseColor, 70, 3.5, 1.0);
  setTimeout(() => burst(x, y, baseColor, 50, 2.8, 0.7), 140);
  setTimeout(() => burst(x, y, baseColor, 40, 2.2, 0.5), 280);
}

function resize() {
  canvas.width = window.innerWidth || 1920;
  canvas.height = window.innerHeight || 1080;
}

function ensureSnowInit() {
  if (snowInitialized) return;
  for (let i = 0; i < SNOW_COUNT; i++) {
    snowParticles.push(createSnow(Math.random() * canvas.width, Math.random() * canvas.height));
  }
  for (let i = 0; i < SPARKLE_COUNT; i++) {
    snowParticles.push(createSparkle(Math.random() * canvas.width, Math.random() * canvas.height));
  }
  snowInitialized = true;
}

function update() {
  // æ¯ãƒ•ãƒ¬ãƒ¼ãƒ å®Œå…¨ã‚¯ãƒªã‚¢ã—ã¦é€éã‚’ç¶­æŒ
  ctx.globalCompositeOperation = "source-over";
  ctx.clearRect(0, 0, canvas.width, canvas.height);

  // ã‚¹ãƒãƒ¼ï¼ˆé€šå¸¸åˆæˆï¼‰
  const now = performance.now();
  if (snowActiveUntil > now) {
    ensureSnowInit();
    snowParticles.forEach((p) => {
      // update
      p.y += p.vy;
      p.x += p.vx;
      const tw = 0.5 + 0.5 * Math.sin(now * p.twinkleSpeed + p.twinkleOffset);
      p.x += Math.sin(now * p.twinkleSpeed + p.twinkleOffset) * (p.type === "snow" ? 0.6 : 0.4);
      if (p.y > canvas.height + 20) {
        p.y = -10;
        p.x = Math.random() * canvas.width;
      }
      if (p.x < -20) p.x = canvas.width + 10;
      if (p.x > canvas.width + 20) p.x = -10;

      // draw
      ctx.save();
      ctx.globalAlpha = p.alpha * tw;
      ctx.fillStyle = "#ffffff";
      if (p.type === "snow") {
        // çµµæ–‡å­—ã‚¹ãƒãƒ¼ã‚’æ··ãœã‚‹
        if (Math.random() < 0.4) {
          const emoji = SNOW_EMOJIS[(Math.random() * SNOW_EMOJIS.length) | 0];
          ctx.font = `${p.r * 4}px "Segoe UI Emoji", "Noto Color Emoji", system-ui, sans-serif`;
          ctx.textAlign = "center";
          ctx.textBaseline = "middle";
          ctx.shadowBlur = 8;
          ctx.shadowColor = "rgba(255,255,255,0.9)";
          ctx.fillText(emoji, p.x, p.y);
        } else {
          ctx.shadowBlur = 8;
          ctx.shadowColor = "rgba(255,255,255,0.8)";
          ctx.beginPath();
          ctx.arc(p.x, p.y, p.r, 0, Math.PI * 2);
          ctx.fill();
        }
      } else {
        ctx.shadowBlur = 12;
        ctx.shadowColor = "rgba(255,255,255,1)";
        ctx.beginPath();
        ctx.moveTo(p.x, p.y - p.r);
        ctx.lineTo(p.x + p.r, p.y);
        ctx.lineTo(p.x, p.y + p.r);
        ctx.lineTo(p.x - p.r, p.y);
        ctx.closePath();
        ctx.fill();
      }
      ctx.restore();
    });
  }

  // ç™ºå…‰åˆæˆã§èŠ±ç«æç”»
  ctx.globalCompositeOperation = "lighter";
  rockets.forEach((r) => r.update());
  rockets = rockets.filter((r) => r.alive);
  rockets.forEach((r) => r.draw());

  particles.forEach((p) => p.update());
  particles = particles.filter((p) => p.alive);
  particles.forEach((p) => p.draw());

  requestAnimationFrame(update);
}

function triggerFireworkCanvas(count = 3) {
  for (let i = 0; i < count; i++) {
    rockets.push(new Rocket());
    if (Math.random() < 0.35) rockets.push(new Rocket());
  }
}

function init() {
  canvas = document.getElementById("fw-canvas");
  ctx = canvas.getContext("2d");
  resize();
  window.addEventListener("resize", resize);
  ctx.globalCompositeOperation = "lighter";
  update();
}

// ã‚³ãƒ¡ãƒ³ãƒˆã‹ã‚‰ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ã‚’æ¤œçŸ¥ã—ã¦èŠ±ç«ã‚’æ‰“ã¡ä¸Šã’ã‚‹
const seen = new Set();
let initialized = false; // åˆå›ã¯å±¥æ­´ã ã‘æ—¢èª­ã«ã—ã¦èŠ±ç«ã‚’å‡ºã•ãªã„
const fireKeywords = ["èŠ±ç«", "ã¯ãªã³", "hanabi", "firework", "fireworks"];
const snowKeywords = ["é›ª", "ã‚†ã", "snow"];

function extractText(msg) {
  if (!msg) return "";
  if (Array.isArray(msg.parts) && msg.parts.length > 0) {
    return msg.parts.filter((p) => p.type === "text").map((p) => p.text || "").join(" ");
  }
  return msg.text || "";
}

function containsFirework(msg) {
  const t = extractText(msg).toLowerCase();
  if (!t) return false;
  return fireKeywords.some((k) => t.includes(k));
}

function containsSnow(msg) {
  const t = extractText(msg).toLowerCase();
  if (!t) return false;
  return snowKeywords.some((k) => t.includes(k));
}
async function pollComments() {
  try {
    const res = await fetch("/comments");
    const data = await res.json();
    let sawAny = false;
    for (const msg of data) {
      const id = msg.id || (msg.timestamp_ms + "_" + (msg.author || "") + "_" + (msg.text || ""));
      if (seen.has(id)) continue;
      sawAny = true;
      seen.add(id);

      // åˆå›ã®å±¥æ­´ã¯æ—¢èª­æ‰±ã„ã§ã‚¹ã‚­ãƒƒãƒ—
      if (!initialized) continue;

      if (containsFirework(msg)) {
        // èŠ±ç«ã ã‘ä¸Šã’ã‚‹
        triggerFireworkCanvas(4);
      }
      if (containsSnow(msg)) {
        snowActiveUntil = performance.now() + 9000; // 9ç§’ã»ã©é™ã‚‰ã›ã‚‹
      }
    }
    if (!initialized && sawAny) {
      initialized = true;
    }
  } catch (e) {
    console.warn("effects poll error", e);
  }
}

init();
setInterval(pollComments, 500);
</script>
</body>
</html>
