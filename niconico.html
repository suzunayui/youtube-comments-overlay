<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<title>Niconico Style Comments</title>
<!-- Google Fonts -->
<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=BIZ+UDGothic&family=Hachi+Maru+Pop&family=Klee+One&family=Kosugi+Maru&family=M+PLUS+1p:wght@400;700&family=M+PLUS+Rounded+1c:wght@400;700&family=Noto+Sans+JP:wght@400;700&family=Yusei+Magic&family=Zen+Maru+Gothic:wght@400;700&display=swap" rel="stylesheet">

<style>
    html, body {
        margin: 0;
        padding: 0;
        overflow: hidden;
        background: rgba(0,0,0,0); /* èƒŒæ™¯é€æ˜ï¼ˆOBSãƒ–ãƒ©ã‚¦ã‚¶ã‚½ãƒ¼ã‚¹å‘ã‘ï¼‰ */
    }

    .bullet {
        position: absolute;
        white-space: nowrap;
        font-family: var(--font-family, "Yu Gothic", "Meiryo", sans-serif);
        -webkit-font-smoothing: antialiased;
        text-rendering: optimizeLegibility;

        /* å¤§ãã‚æ–‡å­—ï¼ˆè¨­å®šã§å¤‰æ›´å¯èƒ½ï¼‰ */
        font-size: var(--font-size, 200px);
        font-weight: var(--font-weight, 900);

        color: var(--color-text, #ffffff);
        pointer-events: none;

        /* å¤ªã„é»’ãƒ•ãƒï¼ˆè¢‹æ–‡å­—ï¼‰ */
        text-shadow: var(--text-shadow,
          -5px -5px 0 #000,
           5px -5px 0 #000,
          -5px  5px 0 #000,
           5px  5px 0 #000,
          -6px  0   0 #000,
           6px  0   0 #000,
           0  -6px  0 #000,
           0   6px  0 #000);

        left: 0; /* å®Ÿéš›ã®ä½ç½®ã¯ JS ã§å‹•ã‹ã™ */
    }

    .bullet img.emoji {
        height: 1.4em;
        vertical-align: middle;
        margin: 0 4px;
    }

    .bullet img.sticker {
        height: var(--font-size, 200px);
        vertical-align: middle;
        margin: 0 6px;
    }
</style>
</head>

<body>

<script>
// å±¥æ­´ã¯ after ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã§ãƒ•ã‚£ãƒ«ã‚¿ã™ã‚‹ãŸã‚ã€åˆå›ã‚¹ã‚­ãƒƒãƒ—ã¯è¡Œã‚ãªã„
let initialized = true;
let seen = new Set();
// ç›´è¿‘æ•°ç§’ã¯æ‹¾ã†ã‚ˆã†ã«ã‚ªãƒ•ã‚»ãƒƒãƒˆã—ã¦å±¥æ­´çˆ†æµã—ã‚’é˜²æ­¢
let sinceTs = Date.now() - 5000;

/* ------------------ è¨­å®šå–å¾— ------------------ */
async function fetchAndApplySettings() {
    try {
        const res = await fetch("/settings/nico");
        const colors = await res.json();
        const root = document.documentElement;

        // hexè‰²ã‚’rgbaã«å¤‰æ›ã™ã‚‹ãƒ˜ãƒ«ãƒ‘ãƒ¼
        function hexToRgba(hex, alpha) {
            const r = parseInt(hex.slice(1, 3), 16);
            const g = parseInt(hex.slice(3, 5), 16);
            const b = parseInt(hex.slice(5, 7), 16);
            return `rgba(${r}, ${g}, ${b}, ${alpha / 100})`;
        }

        root.style.setProperty("--font-family", `"${colors.fontFamily || 'Noto Sans JP'}", "Yu Gothic", "Meiryo", sans-serif`);
        root.style.setProperty("--color-text", hexToRgba(colors.colorText || "#ffffff", colors.alphaText ?? 100));
        
        // ãƒ‹ã‚³ãƒ‹ã‚³é¢¨ãƒ•ã‚©ãƒ³ãƒˆã‚µã‚¤ã‚º
        const fontSize = parseInt(colors.fontSize) || 64;
        root.style.setProperty("--font-size", fontSize + "px");
        
        root.style.setProperty("--font-weight", colors.fontBold !== false ? "900" : "700");
        
        // æµã‚Œã‚‹é€Ÿåº¦ï¼ˆç§’ï¼‰
        const scrollDuration = parseFloat(colors.scrollDuration) || 8;
        root.style.setProperty("--scroll-duration", scrollDuration);

        // ã‚·ãƒ£ãƒ‰ã‚¦ï¼ˆè¢‹æ–‡å­—ï¼‰
        const shadowEnabled = colors.shadowEnabled !== false;
        const shadowColor = colors.colorShadow || "#000000";
        const shadowAlpha = colors.alphaShadow ?? 100;
        if (shadowEnabled) {
            const sc = hexToRgba(shadowColor, shadowAlpha);
            const stroke = Math.max(Math.round(fontSize / 12), 3);
            root.style.setProperty("--text-shadow", `
                -${stroke}px -${stroke}px 0 ${sc},
                 ${stroke}px -${stroke}px 0 ${sc},
                -${stroke}px  ${stroke}px 0 ${sc},
                 ${stroke}px  ${stroke}px 0 ${sc},
                -${stroke+1}px  0   0 ${sc},
                 ${stroke+1}px  0   0 ${sc},
                 0  -${stroke+1}px  0 ${sc},
                 0   ${stroke+1}px  0 ${sc}
            `);
        } else {
            root.style.setProperty("--text-shadow", "none");
        }
    } catch (e) {
        console.error("fetchAndApplySettings error", e);
    }
}

// è¨­å®šã‚’å®šæœŸçš„ã«å–å¾—ï¼ˆ2ç§’ã”ã¨ï¼‰
setInterval(fetchAndApplySettings, 2000);
fetchAndApplySettings();

/* ------------------ å…±é€šãƒ˜ãƒ«ãƒ‘ãƒ¼ ------------------ */

/**
 * ç”»åƒè¾¼ã¿ã§å¹…ãƒ»é«˜ã•ã‚’æ¸¬ã‚‹
 */
function measureSize(div) {
    return new Promise(resolve => {
        const imgs = div.querySelectorAll("img");
        let pending = imgs.length;

        if (pending === 0) {
            resolve({ width: div.offsetWidth, height: div.offsetHeight });
            return;
        }

        imgs.forEach(img => {
            img.onload = img.onerror = () => {
                pending--;
                if (pending === 0) {
                    resolve({ width: div.offsetWidth, height: div.offsetHeight });
                }
            };
        });
    });
}

/**
 * ã€Œçµµæ–‡å­—ã®ã¿ & 5å€‹ä»¥ä¸‹ã€ã‹ã©ã†ã‹åˆ¤å®š
 */
function isShortEmojiOnly(msg) {
    if (!msg || !Array.isArray(msg.parts) || msg.parts.length === 0) return false;

    let emojiCount = 0;

    for (const part of msg.parts) {
        if (part.type === "emoji") {
            emojiCount++;
            continue;
        }
        if (part.type === "text") {
            const t = (part.text || "").trim();
            if (t.length === 0) {
                // ç©ºç™½ãƒ†ã‚­ã‚¹ãƒˆã¯ç„¡è¦–
                continue;
            } else {
                // æ™®é€šã®æ–‡å­—ãŒå…¥ã£ã¦ã‚‹ã®ã§NG
                return false;
            }
        }
        if (part.type === "sticker") {
            // ã‚¹ã‚¿ãƒ³ãƒ—ã¯åˆ¥æ‰±ã„ï¼ˆã“ã“ã§ã¯å¼¾å¹•å´ã«å›ã™ï¼‰
            return false;
        }
    }

    if (emojiCount === 0) return false;
    return emojiCount <= 5;
}

/* ------------------------------------------------------------
   çµµæ–‡å­—è½ä¸‹ï¼ˆä¸Šã‹ã‚‰è½ã¡ã¦åºŠã§è·³ã­ã¦æ¶ˆãˆã‚‹ï¼‰
------------------------------------------------------------ */
function spawnFallingEmoji(msg) {
    const div = document.createElement("div");
    div.className = "bullet emoji-drop";
    const content = document.createElement("span");

    // parts ã‹ã‚‰çµµæ–‡å­—ã ã‘å†æ§‹æˆï¼ˆãƒ†ã‚­ã‚¹ãƒˆã¯ç©ºç™½æ‰±ã„ï¼‰
    if (Array.isArray(msg.parts) && msg.parts.length > 0) {
        for (const part of msg.parts) {
            if (part.type === "emoji") {
                const img = document.createElement("img");
                img.className = "emoji";
                img.src = part.url;
                img.alt = part.alt || "";
                content.append(img);
            } else if (part.type === "text") {
                // ç„¡è¦–ï¼ˆç©ºç™½ã¨ã—ã¦æ‰±ã†ï¼‰
                continue;
            }
        }
    } else {
        // å¿µã®ãŸã‚ãƒ†ã‚­ã‚¹ãƒˆãŒã‚ã‚‹å ´åˆ
        content.textContent = msg.text || " ";
    }

    div.appendChild(content);
    document.body.appendChild(div);

    measureSize(div).then(size => {
        const w = window.innerWidth  || 1920;
        const h = window.innerHeight || 1080;

        // æ¨ªä½ç½®ã¯ãƒ©ãƒ³ãƒ€ãƒ 
        const maxX = Math.max(w - size.width, 0);
        const x = Math.random() * maxX;
        div.style.left = x + "px";

        // ç¸¦ã¯ä¸Šã‹ã‚‰è½ã¨ã™
        let y = -size.height;
        let vy = 0;
        const gravity = 2000;         // px/s^2
        const floorMargin = 50;       // åºŠã‹ã‚‰å°‘ã—ä¸Šã§æ­¢ã¾ã‚‹
        const floorY = h - size.height - floorMargin;
        let bounces = 0;
        const maxBounces = 2;
        let fading = false;
        let fadeStart = 0;
        const fadeDuration = 0.5;     // ç§’

        let lastTime = null;

        function step(timestamp) {
            if (lastTime === null) lastTime = timestamp;
            const dt = (timestamp - lastTime) / 1000;
            lastTime = timestamp;

            if (!fading) {
                vy += gravity * dt;
                y += vy * dt;

                if (y >= floorY) {
                    y = floorY;
                    if (Math.abs(vy) < 200 || bounces >= maxBounces) {
                        // ã»ã¼æ­¢ã¾ã£ãŸ â†’ ãƒ•ã‚§ãƒ¼ãƒ‰é–‹å§‹
                        fading = true;
                        fadeStart = performance.now();
                    } else {
                        // ã½ã‚ˆã‚“ã¨ãƒã‚¦ãƒ³ãƒ‰
                        vy = -vy * 0.4; // æ¸›è¡°
                        bounces++;
                    }
                }

                div.style.top = y + "px";
            } else {
                // ãƒ•ã‚§ãƒ¼ãƒ‰ã‚¢ã‚¦ãƒˆ
                const t = (timestamp - fadeStart) / 1000;
                const ratio = Math.min(t / fadeDuration, 1);
                div.style.opacity = String(1 - ratio);
                if (ratio >= 1) {
                    div.remove();
                    return;
                }
            }

            requestAnimationFrame(step);
        }

        requestAnimationFrame(step);
    });
}

/* ------------------------------------------------------------
   é€šå¸¸ã®ãƒ‹ã‚³ãƒ‹ã‚³å¼¾å¹•ï¼ˆå³â†’å·¦ã¸10ç§’ã§æµã‚Œã‚‹ï¼‰
------------------------------------------------------------ */
function spawnScrollingBullet(msg, { onComplete, color } = {}) {
    const div = document.createElement("div");
    div.className = "bullet";
    const content = document.createElement("span");

    const rawText = (msg.text || "").trim();

    if (Array.isArray(msg.parts) && msg.parts.length > 0) {
        for (const part of msg.parts) {
            if (part.type === "text") {
                content.append(document.createTextNode(part.text || ""));
            } else if (part.type === "emoji") {
                const img = document.createElement("img");
                img.className = "emoji";
                img.src = part.url;
                img.alt = part.alt || "";
                content.append(img);
            } else if (part.type === "sticker") {
                const img = document.createElement("img");
                img.className = "sticker";
                img.src = part.url;
                img.alt = part.alt || "";
                content.append(img);
            }
        }
    } else {
        content.textContent = rawText || (msg.author ? msg.author + " ã•ã‚“" : " ");
    }

    div.appendChild(content);
    document.body.appendChild(div);

    measureSize(div).then(size => {
        const w = window.innerWidth  || 1920;
        const h = window.innerHeight || 1080;

        // --- ä¸Šä¸‹100pxä½™ç™½ã‚’ç©ºã‘ã¦ã€ãã®é–“ã‚’ãƒ©ãƒ³ãƒ€ãƒ  ---
        const marginTop = 100;
        const marginBottom = 100;
        const usableHeight = Math.max(h - marginTop - marginBottom - size.height, 0);
        const y = marginTop + Math.random() * usableHeight;
        div.style.top = y + "px";

        // --- æ¨ªã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«è¨­å®š ---
        let x = w;                // ç”»é¢å³ã®å¤–ã‹ã‚‰ã‚¹ã‚¿ãƒ¼ãƒˆ
        const endX = -size.width; // ã‚³ãƒ¡ãƒ³ãƒˆå³ç«¯ãŒå·¦ã®å¤–ã¸å‡ºãŸä½ç½®

        // â˜… è¨­å®šã‹ã‚‰æµã‚Œã‚‹æ™‚é–“ã‚’å–å¾—
        const visibleDuration = parseFloat(getComputedStyle(document.documentElement).getPropertyValue('--scroll-duration')) || 8;
        const speed = (w + size.width) / visibleDuration; // px/sec

        if (color) {
            div.style.color = color;
        }

        let lastTime = null;

        function step(timestamp) {
            if (lastTime === null) lastTime = timestamp;
            const dt = (timestamp - lastTime) / 1000;
            lastTime = timestamp;

            x -= speed * dt;
            div.style.left = x + "px";

            if (x + size.width < 0) {
                if (typeof onComplete === "function") {
                    onComplete();
                }
                div.remove();
                return;
            }

            requestAnimationFrame(step);
        }

        requestAnimationFrame(step);
    });
}

/* ------------------------------------------------------------
   ã‚³ãƒ¡ãƒ³ãƒˆå–å¾—ï¼ˆ/comments â†’ å¼¾å¹•ã«æµã™ï¼‰
   â˜… åˆã‚ã¦ã€Œã‚³ãƒ¡ãƒ³ãƒˆãŒæ¥ãŸãƒãƒƒãƒã€ã¯å±¥æ­´æ‰±ã„ã§ã‚¹ã‚­ãƒƒãƒ—
------------------------------------------------------------ */
async function fetchComments() {
    try {
        const res = await fetch(`/comments?after=${sinceTs}`);
        const data = await res.json();

        let sawAnyInThisBatch = false;
        let maxTs = sinceTs;

        for (const msg of data) {
            const id = msg.id || (msg.timestamp_ms + "_" + (msg.author || "") + "_" + (msg.text || ""));

            if (!seen.has(id)) {
                seen.add(id);
                sawAnyInThisBatch = true;
                if (msg.timestamp_ms && msg.timestamp_ms > maxTs) {
                    maxTs = msg.timestamp_ms;
                }

                // â˜… çµµæ–‡å­—ã®ã¿5å€‹ä»¥ä¸‹ â†’ è½ä¸‹æ¼”å‡º
                const hasChisai = containsChisai(msg);

                if (isShortEmojiOnly(msg)) {
                    spawnFallingEmoji(msg);
                } else {
                    spawnScrollingBullet(msg, {
                        onComplete: hasChisai
                            ? () => spawnScrollingBullet({ text: "ã¡ã£ã¡ã‚ƒããªã„ã‚ˆğŸ’¢" }, { color: "#ff0000" })
                            : undefined,
                    });
                }
            }
        }

        // æ¬¡å›ä»¥é™ã¯ä»Šå›ã®æœ€æ–° timestamp_ms ã‚ˆã‚Šæ–°ã—ã„ã‚‚ã®ã ã‘å–å¾—ã™ã‚‹
        sinceTs = maxTs;

    } catch (err) {
        console.error("fetch error:", err);
    }
}

/* ãƒãƒ¼ãƒªãƒ³ã‚°ï¼ˆ0.5ç§’ã”ã¨ï¼‰ */
setInterval(fetchComments, 500);
fetchComments();

// ã€Œå°ã•ã„ã€ãŒå«ã¾ã‚Œã‚‹ã‹åˆ¤å®šï¼ˆparts ã® text ã‚‚å¯¾è±¡ï¼‰
function containsChisai(msg) {
    const target = "å°ã•ã„";
    if (typeof msg?.text === "string" && msg.text.includes(target)) return true;
    if (Array.isArray(msg?.parts)) {
        return msg.parts.some((p) => p.type === "text" && typeof p.text === "string" && p.text.includes(target));
    }
    return false;
}
</script>

</body>
</html>
