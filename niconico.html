<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<title>Niconico Style Comments</title>
<!-- Google Fonts -->
<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=BIZ+UDGothic&family=Hachi+Maru+Pop&family=Klee+One&family=Kosugi+Maru&family=M+PLUS+1p:wght@400;700&family=M+PLUS+Rounded+1c:wght@400;700&family=Noto+Sans+JP:wght@400;700&family=Yusei+Magic&family=Zen+Maru+Gothic:wght@400;700&display=swap" rel="stylesheet">

<style>
    html, body {
        margin: 0;
        padding: 0;
        overflow: hidden;
        background: rgba(0,0,0,0); /* 背景透明（OBSブラウザソース向け） */
    }

    .bullet {
        position: absolute;
        white-space: nowrap;
        font-family: var(--font-family, "Yu Gothic", "Meiryo", sans-serif);

        /* 大きめ文字（設定で変更可能） */
        font-size: var(--font-size, 200px);
        font-weight: var(--font-weight, 900);

        color: var(--color-text, #ffffff);
        pointer-events: none;

        /* 太い黒フチ（袋文字） */
        text-shadow: var(--text-shadow,
          -5px -5px 0 #000,
           5px -5px 0 #000,
          -5px  5px 0 #000,
           5px  5px 0 #000,
          -6px  0   0 #000,
           6px  0   0 #000,
           0  -6px  0 #000,
           0   6px  0 #000);

        left: 0; /* 実際の位置は JS で動かす */
    }

    .bullet img.emoji {
        height: 1.4em;
        vertical-align: middle;
        margin: 0 4px;
    }

    .bullet img.sticker {
        height: var(--font-size, 200px);
        vertical-align: middle;
        margin: 0 6px;
    }
</style>
</head>

<body>

<script>
let initialized = false;     // ★ 初回「履歴スキップ」モードかどうか
let seen = new Set();

/* ------------------ 設定取得 ------------------ */
async function fetchAndApplySettings() {
    try {
        const res = await fetch("/settings/nico");
        const colors = await res.json();
        const root = document.documentElement;

        // hex色をrgbaに変換するヘルパー
        function hexToRgba(hex, alpha) {
            const r = parseInt(hex.slice(1, 3), 16);
            const g = parseInt(hex.slice(3, 5), 16);
            const b = parseInt(hex.slice(5, 7), 16);
            return `rgba(${r}, ${g}, ${b}, ${alpha / 100})`;
        }

        root.style.setProperty("--font-family", `"${colors.fontFamily || 'Noto Sans JP'}", "Yu Gothic", "Meiryo", sans-serif`);
        root.style.setProperty("--color-text", hexToRgba(colors.colorText || "#ffffff", colors.alphaText ?? 100));
        
        // ニコニコ風フォントサイズ
        const fontSize = parseInt(colors.fontSize) || 64;
        root.style.setProperty("--font-size", fontSize + "px");
        
        root.style.setProperty("--font-weight", colors.fontBold !== false ? "900" : "700");
        
        // 流れる速度（秒）
        const scrollDuration = parseFloat(colors.scrollDuration) || 8;
        root.style.setProperty("--scroll-duration", scrollDuration);

        // シャドウ（袋文字）
        const shadowEnabled = colors.shadowEnabled !== false;
        const shadowColor = colors.colorShadow || "#000000";
        const shadowAlpha = colors.alphaShadow ?? 100;
        if (shadowEnabled) {
            const sc = hexToRgba(shadowColor, shadowAlpha);
            const stroke = Math.max(Math.round(fontSize / 12), 3);
            root.style.setProperty("--text-shadow", `
                -${stroke}px -${stroke}px 0 ${sc},
                 ${stroke}px -${stroke}px 0 ${sc},
                -${stroke}px  ${stroke}px 0 ${sc},
                 ${stroke}px  ${stroke}px 0 ${sc},
                -${stroke+1}px  0   0 ${sc},
                 ${stroke+1}px  0   0 ${sc},
                 0  -${stroke+1}px  0 ${sc},
                 0   ${stroke+1}px  0 ${sc}
            `);
        } else {
            root.style.setProperty("--text-shadow", "none");
        }
    } catch (e) {
        console.error("fetchAndApplySettings error", e);
    }
}

// 設定を定期的に取得（2秒ごと）
setInterval(fetchAndApplySettings, 2000);
fetchAndApplySettings();

/* ------------------ 共通ヘルパー ------------------ */

/**
 * 画像込みで幅・高さを測る
 */
function measureSize(div) {
    return new Promise(resolve => {
        const imgs = div.querySelectorAll("img");
        let pending = imgs.length;

        if (pending === 0) {
            resolve({ width: div.offsetWidth, height: div.offsetHeight });
            return;
        }

        imgs.forEach(img => {
            img.onload = img.onerror = () => {
                pending--;
                if (pending === 0) {
                    resolve({ width: div.offsetWidth, height: div.offsetHeight });
                }
            };
        });
    });
}

/**
 * 「絵文字のみ & 5個以下」かどうか判定
 */
function isShortEmojiOnly(msg) {
    if (!msg || !Array.isArray(msg.parts) || msg.parts.length === 0) return false;

    let emojiCount = 0;

    for (const part of msg.parts) {
        if (part.type === "emoji") {
            emojiCount++;
            continue;
        }
        if (part.type === "text") {
            const t = (part.text || "").trim();
            if (t.length === 0) {
                // 空白テキストは無視
                continue;
            } else {
                // 普通の文字が入ってるのでNG
                return false;
            }
        }
        if (part.type === "sticker") {
            // スタンプは別扱い（ここでは弾幕側に回す）
            return false;
        }
    }

    if (emojiCount === 0) return false;
    return emojiCount <= 5;
}

/* ------------------------------------------------------------
   絵文字落下（上から落ちて床で跳ねて消える）
------------------------------------------------------------ */
function spawnFallingEmoji(msg) {
    const div = document.createElement("div");
    div.className = "bullet emoji-drop";
    const content = document.createElement("span");

    // parts から絵文字だけ再構成（テキストは空白扱い）
    if (Array.isArray(msg.parts) && msg.parts.length > 0) {
        for (const part of msg.parts) {
            if (part.type === "emoji") {
                const img = document.createElement("img");
                img.className = "emoji";
                img.src = part.url;
                img.alt = part.alt || "";
                content.append(img);
            } else if (part.type === "text") {
                // 無視（空白として扱う）
                continue;
            }
        }
    } else {
        // 念のためテキストがある場合
        content.textContent = msg.text || " ";
    }

    div.appendChild(content);
    document.body.appendChild(div);

    measureSize(div).then(size => {
        const w = window.innerWidth  || 1920;
        const h = window.innerHeight || 1080;

        // 横位置はランダム
        const maxX = Math.max(w - size.width, 0);
        const x = Math.random() * maxX;
        div.style.left = x + "px";

        // 縦は上から落とす
        let y = -size.height;
        let vy = 0;
        const gravity = 2000;         // px/s^2
        const floorMargin = 50;       // 床から少し上で止まる
        const floorY = h - size.height - floorMargin;
        let bounces = 0;
        const maxBounces = 2;
        let fading = false;
        let fadeStart = 0;
        const fadeDuration = 0.5;     // 秒

        let lastTime = null;

        function step(timestamp) {
            if (lastTime === null) lastTime = timestamp;
            const dt = (timestamp - lastTime) / 1000;
            lastTime = timestamp;

            if (!fading) {
                vy += gravity * dt;
                y += vy * dt;

                if (y >= floorY) {
                    y = floorY;
                    if (Math.abs(vy) < 200 || bounces >= maxBounces) {
                        // ほぼ止まった → フェード開始
                        fading = true;
                        fadeStart = performance.now();
                    } else {
                        // ぽよんとバウンド
                        vy = -vy * 0.4; // 減衰
                        bounces++;
                    }
                }

                div.style.top = y + "px";
            } else {
                // フェードアウト
                const t = (timestamp - fadeStart) / 1000;
                const ratio = Math.min(t / fadeDuration, 1);
                div.style.opacity = String(1 - ratio);
                if (ratio >= 1) {
                    div.remove();
                    return;
                }
            }

            requestAnimationFrame(step);
        }

        requestAnimationFrame(step);
    });
}

/* ------------------------------------------------------------
   通常のニコニコ弾幕（右→左へ10秒で流れる）
------------------------------------------------------------ */
function spawnScrollingBullet(msg) {
    const div = document.createElement("div");
    div.className = "bullet";
    const content = document.createElement("span");

    const rawText = (msg.text || "").trim();

    if (Array.isArray(msg.parts) && msg.parts.length > 0) {
        for (const part of msg.parts) {
            if (part.type === "text") {
                content.append(document.createTextNode(part.text || ""));
            } else if (part.type === "emoji") {
                const img = document.createElement("img");
                img.className = "emoji";
                img.src = part.url;
                img.alt = part.alt || "";
                content.append(img);
            } else if (part.type === "sticker") {
                const img = document.createElement("img");
                img.className = "sticker";
                img.src = part.url;
                img.alt = part.alt || "";
                content.append(img);
            }
        }
    } else {
        content.textContent = rawText || (msg.author ? msg.author + " さん" : " ");
    }

    div.appendChild(content);
    document.body.appendChild(div);

    measureSize(div).then(size => {
        const w = window.innerWidth  || 1920;
        const h = window.innerHeight || 1080;

        // --- 上下100px余白を空けて、その間をランダム ---
        const marginTop = 100;
        const marginBottom = 100;
        const usableHeight = Math.max(h - marginTop - marginBottom - size.height, 0);
        const y = marginTop + Math.random() * usableHeight;
        div.style.top = y + "px";

        // --- 横スクロール設定 ---
        let x = w;                // 画面右の外からスタート
        const endX = -size.width; // コメント右端が左の外へ出た位置

        // ★ 設定から流れる時間を取得
        const visibleDuration = parseFloat(getComputedStyle(document.documentElement).getPropertyValue('--scroll-duration')) || 8;
        const speed = (w + size.width) / visibleDuration; // px/sec

        let lastTime = null;

        function step(timestamp) {
            if (lastTime === null) lastTime = timestamp;
            const dt = (timestamp - lastTime) / 1000;
            lastTime = timestamp;

            x -= speed * dt;
            div.style.left = x + "px";

            if (x + size.width < 0) {
                div.remove();
                return;
            }

            requestAnimationFrame(step);
        }

        requestAnimationFrame(step);
    });
}

/* ------------------------------------------------------------
   コメント取得（/comments → 弾幕に流す）
   ★ 初めて「コメントが来たバッチ」は履歴扱いでスキップ
------------------------------------------------------------ */
async function fetchComments() {
    try {
        const res = await fetch("/comments");
        const data = await res.json();

        let sawAnyInThisBatch = false;

        for (const msg of data) {
            const id = msg.id || (msg.timestamp_ms + "_" + (msg.author || "") + "_" + (msg.text || ""));

            if (!initialized) {
                // 初回モード中：履歴として既読扱いのみ
                seen.add(id);
                sawAnyInThisBatch = true;
                continue;
            }

            if (!seen.has(id)) {
                seen.add(id);
                sawAnyInThisBatch = true;

                // ★ 絵文字のみ5個以下 → 落下演出
                if (isShortEmojiOnly(msg)) {
                    spawnFallingEmoji(msg);
                } else {
                    spawnScrollingBullet(msg);
                }
            }
        }

        if (!initialized && sawAnyInThisBatch) {
            initialized = true;
            console.log("NICONICO overlay initialized: history skipped.");
        }

    } catch (err) {
        console.error("fetch error:", err);
    }
}

/* ポーリング（0.5秒ごと） */
setInterval(fetchComments, 500);
fetchComments();
</script>

</body>
</html>