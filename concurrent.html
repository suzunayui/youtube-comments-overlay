<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <title>Concurrent Viewers</title>
  <style>
    html, body {
      margin: 0;
      padding: 0;
      background: transparent;
      overflow: hidden;
      width: 100%;
      height: 100%;
    }

    body {
      display: flex;
      align-items: center;
      justify-content: center;
      font-family: "Segoe UI", system-ui, sans-serif;
    }

    .stack {
      display: flex;
      flex-direction: column;
      gap: 8px;
      align-items: center;
    }

    .badge {
      display: inline-flex;
      align-items: center;
      gap: 0;
      padding: 6px 14px;
      border-radius: 8px;
      background: #000000;
      color: #ffffff;
      font-weight: 700;
      -webkit-text-stroke: 0px transparent;
      text-shadow: none;
      font-size: 24px;
    }

    .label {
      font-size: 24px;
    }

    .number {
      font-size: 28px;
      margin: 0 4px;
    }

    .unit {
      font-size: 24px;
    }

    @keyframes pop {
      0%   { transform: scale(1); }
      30%  { transform: scale(1.07); }
      60%  { transform: scale(0.95); }
      100% { transform: scale(1); }
    }
    .changed {
      animation: pop 0.25s ease-out;
    }
  </style>
</head>
<body>

  <div class="stack">
    <div class="badge" id="badge">
      <span class="label">同時接続</span>
      <span class="number" id="number">-</span>
      <span class="unit">人</span>
    </div>

    <div class="badge" id="likesBadge">
      <span class="label">高評価</span>
      <span class="number" id="likesNumber">-</span>
      <span class="unit">件</span>
    </div>
  </div>

  <script>
    let lastValue = null;
    let lastLikes = null;

    async function fetchConcurrent() {
      try {
        const res = await fetch("/api/concurrent", { cache: "no-store" });
        const data = await res.json();
        const viewers = Number(data?.viewers ?? 0);
        const likes = Number(data?.likes ?? NaN);

        if (Number.isFinite(viewers)) {
          const numEl = document.getElementById("number");
          const badgeEl = document.getElementById("badge");

          if (viewers !== lastValue) {
            numEl.textContent = viewers;
            lastValue = viewers;

            badgeEl.classList.remove("changed");
            void badgeEl.offsetWidth;
            badgeEl.classList.add("changed");
          }
        }

        if (Number.isFinite(likes)) {
          const likesEl = document.getElementById("likesNumber");
          const likesBadge = document.getElementById("likesBadge");

          if (likes !== lastLikes) {
            likesEl.textContent = likes;
            lastLikes = likes;

            likesBadge.classList.remove("changed");
            void likesBadge.offsetWidth;
            likesBadge.classList.add("changed");
          }
        }
      } catch (e) {
        console.warn("fetchConcurrent error:", e);
      }
    }

    fetchConcurrent();
    setInterval(fetchConcurrent, 5000);
  </script>

</body>
</html>
