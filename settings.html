<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8" />
<title>YouTube Chat Overlay è¨­å®š</title>
<style>
  body {
    margin: 0;
    padding: 12px;
    font-family: "Yu Gothic", "Meiryo", sans-serif;
    background: #1e1e2f;
    color: #f5f5f5;
    overflow: hidden;
  }

  .container {
    display: flex;
    gap: 12px;
    height: calc(100vh - 24px);
  }

  .left-panel {
    flex: 1;
    min-width: 280px;
    display: flex;
    flex-direction: column;
  }

  .right-panel {
    flex: 1;
    min-width: 280px;
    overflow-y: auto;
  }

  h1 {
    font-size: 18px;
    margin: 0 0 8px 0;
  }

  label {
    display: block;
    margin-top: 8px;
    font-size: 13px;
  }

  input[type="text"] {
    width: 100%;
    padding: 6px 8px;
    margin-top: 4px;
    border-radius: 4px;
    border: 1px solid #555;
    background: #2a2a3d;
    color: #f5f5f5;
    box-sizing: border-box;
  }

  .buttons {
    margin-top: 10px;
    display: flex;
    gap: 8px;
  }

  button {
    flex: 1;
    padding: 6px 0;
    border-radius: 6px;
    border: none;
    cursor: pointer;
    font-weight: 700;
    font-size: 13px;
  }

  #btnStart {
    background: #4caf50;
    color: #fff;
  }

  #btnStop {
    background: #f44336;
    color: #fff;
  }

  #status {
    margin-top: 8px;
    font-size: 12px;
  }

  .small {
    font-size: 10px;
    color: #ccccff;
    margin-top: 6px;
  }

  #launchersBox {
    margin-top: 10px;
    padding: 6px;
    border-radius: 6px;
    background: #25253a;
    font-size: 10px;
  }

  #launchersBox code {
    background: #333;
    padding: 1px 3px;
    border-radius: 3px;
  }

  #btnOpenLaunchers {
    margin-top: 4px;
    padding: 3px 6px;
    font-size: 10px;
    border-radius: 4px;
    border: none;
    cursor: pointer;
    background: #3f51b5;
    color: #fff;
  }

  .color-settings {
    padding: 10px;
    background: #25253a;
    border-radius: 8px;
    height: 100%;
    box-sizing: border-box;
  }

  .color-settings h2 {
    font-size: 14px;
    margin: 0 0 8px 0;
    border-bottom: 1px solid #444;
    padding-bottom: 6px;
  }

  .color-row {
    display: flex;
    align-items: center;
    margin-bottom: 6px;
    gap: 8px;
  }

  .color-row label {
    flex: 1;
    margin: 0;
    font-size: 12px;
    min-width: 90px;
  }

  .color-row input[type="color"] {
    width: 32px;
    height: 24px;
    padding: 0;
    border: 2px solid #555;
    border-radius: 4px;
    cursor: pointer;
    background: transparent;
  }

  .color-row input[type="number"] {
    width: 50px;
    padding: 3px 5px;
    border-radius: 4px;
    border: 1px solid #555;
    background: #2a2a3d;
    color: #f5f5f5;
    font-size: 11px;
  }

  .color-row input[type="range"] {
    width: 60px;
    cursor: pointer;
  }

  .color-row input[type="checkbox"] {
    width: 16px;
    height: 16px;
    cursor: pointer;
  }

  .color-row select {
    flex: 1;
    max-width: 150px;
    padding: 3px 5px;
    border-radius: 4px;
    border: 1px solid #555;
    background: #2a2a3d;
    color: #f5f5f5;
    font-size: 11px;
    cursor: pointer;
  }

  .alpha-value {
    font-size: 10px;
    color: #aaa;
    width: 30px;
    text-align: right;
  }

  #btnResetColors {
    margin-top: 8px;
    padding: 5px 10px;
    font-size: 11px;
    border-radius: 4px;
    border: none;
    cursor: pointer;
    background: #666;
    color: #fff;
  }

  #btnResetColors:hover {
    background: #888;
  }

  .color-category {
    margin-top: 10px;
    font-size: 11px;
    color: #aaa;
    border-top: 1px solid #333;
    padding-top: 6px;
  }

  .color-category:first-of-type {
    margin-top: 0;
    border-top: none;
    padding-top: 0;
  }
</style>
</head>
<body>
<div class="container">
  <div class="left-panel">
    <h1>YouTube Chat Overlay</h1>

    <label>
      ãƒãƒ£ãƒ³ãƒãƒ«ID / @ãƒãƒ³ãƒ‰ãƒ« / å‹•ç”»ID
      <input type="text" id="inputTarget" placeholder="@ã™ãšãªã‚†ã„ / UCxxxx / abcdefghijk" />
    </label>

    <div class="buttons">
      <button id="btnStart">ãƒãƒ£ãƒƒãƒˆå–å¾—é–‹å§‹</button>
      <button id="btnStop">åœæ­¢</button>
    </div>

    <div id="status">ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹: åœæ­¢ä¸­</div>

    <div id="launchersBox">
      <div id="launchersPath">OBS ç”¨ãƒ©ãƒ³ãƒãƒ£ãƒ¼: æº–å‚™ä¸­â€¦</div>
      <button id="btnOpenLaunchers">ãƒ•ã‚©ãƒ«ãƒ€ã‚’é–‹ãï¼ˆãƒ‰ãƒ©ãƒƒã‚°ç”¨ï¼‰</button>
      <div class="small">
        ãƒ•ã‚©ãƒ«ãƒ€å†…ã® <code>*.html</code> ã‚’ OBS ã«ãƒ‰ãƒ©ãƒƒã‚°ï¼†ãƒ‰ãƒ­ãƒƒãƒ—
      </div>
    </div>

    <div class="small">
      ç›´æ¥ URL ã§ä½¿ã†å ´åˆï¼š<br />
      ãƒ»é€šå¸¸: <code>http://127.0.0.1:5000/</code><br />
      ãƒ»ãƒ‹ã‚³ãƒ‹ã‚³é¢¨: <code>http://127.0.0.1:5000/niconico</code><br />
      ãƒ»ã‚¹ãƒ‘ãƒãƒ£å°‚ç”¨: <code>http://127.0.0.1:5000/supers</code>
    </div>
  </div>

  <div class="right-panel">
    <div class="color-settings">
      <h2>ğŸ¨ ã‚ªãƒ¼ãƒãƒ¼ãƒ¬ã‚¤è‰²è¨­å®š</h2>

      <div class="color-category">åŸºæœ¬ã‚¹ã‚¿ã‚¤ãƒ«</div>
      <div class="color-row">
        <label>ãƒ•ã‚©ãƒ³ãƒˆ</label>
        <select id="fontFamily">
          <optgroup label="â€” Webãƒ•ã‚©ãƒ³ãƒˆ (Google Fonts) â€”">
            <option value="Noto Sans JP">Noto Sans JP</option>
            <option value="M PLUS Rounded 1c">M PLUS Rounded 1c</option>
            <option value="M PLUS 1p">M PLUS 1p</option>
            <option value="Kosugi Maru">å°æ‰ä¸¸ã‚´ã‚·ãƒƒã‚¯</option>
            <option value="Zen Maru Gothic">Zen Maru Gothic</option>
            <option value="BIZ UDGothic">BIZ UDã‚´ã‚·ãƒƒã‚¯</option>
            <option value="Klee One">Klee One</option>
            <option value="Yusei Magic">Yusei Magic</option>
            <option value="Hachi Maru Pop">ã¯ã¡ã¾ã‚‹ãƒãƒƒãƒ—</option>
          </optgroup>
          <optgroup label="â€” ã‚·ã‚¹ãƒ†ãƒ ãƒ•ã‚©ãƒ³ãƒˆ â€”">
            <option value="Yu Gothic">æ¸¸ã‚´ã‚·ãƒƒã‚¯</option>
            <option value="Meiryo">ãƒ¡ã‚¤ãƒªã‚ª</option>
            <option value="MS Gothic">MS ã‚´ã‚·ãƒƒã‚¯</option>
            <option value="Hiragino Sans">ãƒ’ãƒ©ã‚®ãƒè§’ã‚´</option>
            <option value="Arial">Arial</option>
            <option value="Comic Sans MS">Comic Sans MS</option>
            <option value="Impact">Impact</option>
          </optgroup>
          <optgroup id="installedFontsGroup" label="â€” ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«æ¸ˆã¿ãƒ•ã‚©ãƒ³ãƒˆ â€”">
          </optgroup>
        </select>
      </div>
      <div class="color-row">
        <label>é€šå¸¸ã‚³ãƒ¡ãƒ³ãƒˆèƒŒæ™¯</label>
        <input type="color" id="colorNormal" value="#000000" />
        <input type="range" id="alphaNormal" min="0" max="100" value="100" />
        <span class="alpha-value" id="alphaNormalVal">100%</span>
      </div>
      <div class="color-row">
        <label>æ–‡å­—è‰²</label>
        <input type="color" id="colorText" value="#ffffff" />
        <input type="range" id="alphaText" min="0" max="100" value="100" />
        <span class="alpha-value" id="alphaTextVal">100%</span>
      </div>
      <div class="color-row">
        <label>æŠ•ç¨¿è€…åã®è‰²</label>
        <input type="color" id="colorAuthor" value="#ffd8f8" />
        <input type="range" id="alphaAuthor" min="0" max="100" value="100" />
        <span class="alpha-value" id="alphaAuthorVal">100%</span>
      </div>
      <div class="color-row">
        <label>ãƒ•ã‚©ãƒ³ãƒˆã‚µã‚¤ã‚º (px)</label>
        <input type="number" id="fontSize" value="22" min="10" max="48" />
      </div>
      <div class="color-row">
        <label>å¤ªå­— (ãƒœãƒ¼ãƒ«ãƒ‰)</label>
        <input type="checkbox" id="fontBold" checked />
        <span style="font-size:11px; margin-left:4px;">æœ‰åŠ¹</span>
      </div>
      <div class="color-row">
        <label>æ–‡å­—ã®å½±</label>
        <input type="checkbox" id="shadowEnabled" checked />
        <span style="font-size:11px; margin-left:4px;">æœ‰åŠ¹</span>
      </div>
      <div class="color-row">
        <label>å½±ã®è‰²</label>
        <input type="color" id="colorShadow" value="#000000" />
        <input type="range" id="alphaShadow" min="0" max="100" value="90" />
        <span class="alpha-value" id="alphaShadowVal">90%</span>
      </div>

      <div class="color-category">ãƒ¡ãƒ³ãƒãƒ¼ã‚·ãƒƒãƒ— / ã‚®ãƒ•ãƒˆ</div>
      <div class="color-row">
        <label>ãƒ¡ãƒ³ãƒãƒ¼ã‚·ãƒƒãƒ—ç³»èƒŒæ™¯</label>
        <input type="color" id="colorMembership" value="#1e7d32" />
        <input type="range" id="alphaMembership" min="0" max="100" value="100" />
        <span class="alpha-value" id="alphaMembershipVal">100%</span>
      </div>

      <button id="btnResetColors">ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã«æˆ»ã™</button>
    </div>
  </div>
</div>

  <script>
    const { ipcRenderer } = require("electron");

    const inputTarget = document.getElementById("inputTarget");
    const btnStart = document.getElementById("btnStart");
    const btnStop = document.getElementById("btnStop");
    const statusEl = document.getElementById("status");

    const launchersPathEl = document.getElementById("launchersPath");
    const btnOpenLaunchers = document.getElementById("btnOpenLaunchers");

    const KEY = "yt-overlay-input";

    window.addEventListener("DOMContentLoaded", () => {
      const saved = localStorage.getItem(KEY);
      if (saved) {
        inputTarget.value = saved;
      }
    });

    btnStart.addEventListener("click", () => {
      const v = inputTarget.value.trim();
      if (!v) {
        statusEl.textContent = "ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹: å…¥åŠ›ãŒç©ºã§ã™";
        return;
      }

      localStorage.setItem(KEY, v);

      statusEl.textContent = "ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹: èµ·å‹•ä¸­â€¦";
      ipcRenderer.send("chat:start", v);
    });

    btnStop.addEventListener("click", () => {
      ipcRenderer.send("chat:stop");
      statusEl.textContent = "ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹: åœæ­¢è¦æ±‚ã‚’é€ä¿¡ã—ã¾ã—ãŸâ€¦";
    });

    // ãƒ¡ã‚¤ãƒ³ãƒ—ãƒ­ã‚»ã‚¹ã‹ã‚‰ã®ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹é€šçŸ¥
    ipcRenderer.on("chat:status", (_event, state) => {
      if (state === "starting") {
        statusEl.textContent = "ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹: èµ·å‹•ä¸­â€¦";
      } else if (state === "stopped") {
        statusEl.textContent = "ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹: åœæ­¢ä¸­";
      } else {
        statusEl.textContent = "ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹: " + state;
      }
    });

    ipcRenderer.on("chat:error", (_event, message) => {
      statusEl.textContent = "ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹: ã‚¨ãƒ©ãƒ¼: " + message;
    });

    // ãƒ©ãƒ³ãƒãƒ£ãƒ¼ãƒ•ã‚©ãƒ«ãƒ€ã®ãƒ‘ã‚¹è¡¨ç¤º
    ipcRenderer.on("launchers:path", (_event, dirPath) => {
      launchersPathEl.textContent = "OBS ç”¨ãƒ©ãƒ³ãƒãƒ£ãƒ¼ãƒ•ã‚©ãƒ«ãƒ€: " + dirPath;
    });

    btnOpenLaunchers.addEventListener("click", () => {
      ipcRenderer.send("launchers:open");
    });

    // ========== ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«æ¸ˆã¿ãƒ•ã‚©ãƒ³ãƒˆæ¤œå‡º ==========
    async function detectInstalledFonts() {
      const installedGroup = document.getElementById("installedFontsGroup");
      
      // Local Font Access API ãŒä½¿ãˆã‚‹å ´åˆ
      if ("queryLocalFonts" in window) {
        try {
          const fonts = await window.queryLocalFonts();
          const fontFamilies = new Set();
          for (const font of fonts) {
            fontFamilies.add(font.family);
          }
          
          // æ—¥æœ¬èªãƒ•ã‚©ãƒ³ãƒˆã‚’å„ªå…ˆçš„ã«è¡¨ç¤º
          const jpFonts = [];
          const otherFonts = [];
          
          for (const family of fontFamilies) {
            // æ—¢ã«ãƒªã‚¹ãƒˆã«ã‚ã‚‹ã‚‚ã®ã¯é™¤å¤–
            const existingOptions = document.querySelectorAll("#fontFamily option");
            let exists = false;
            for (const opt of existingOptions) {
              if (opt.value === family) {
                exists = true;
                break;
              }
            }
            if (exists) continue;
            
            // æ—¥æœ¬èªãƒ•ã‚©ãƒ³ãƒˆã£ã½ã„ã‚‚ã®ã‚’åˆ¤å®š
            if (/[\u3040-\u309F\u30A0-\u30FF\u4E00-\u9FAF]|Gothic|Mincho|Meiryo|Yu|Hiragino|Noto.*JP|Source Han|ã‚´ã‚·ãƒƒã‚¯|æ˜æœ/.test(family)) {
              jpFonts.push(family);
            } else {
              otherFonts.push(family);
            }
          }
          
          jpFonts.sort();
          otherFonts.sort();
          
          for (const family of [...jpFonts, ...otherFonts].slice(0, 50)) {
            const option = document.createElement("option");
            option.value = family;
            option.textContent = family;
            installedGroup.appendChild(option);
          }
        } catch (e) {
          console.log("Font detection not available:", e);
        }
      }
    }
    
    detectInstalledFonts();

    // ========== ã‚«ãƒ©ãƒ¼è¨­å®š ==========
    const COLOR_KEY = "yt-overlay-colors";

    const defaultColors = {
      fontFamily: "Noto Sans JP",
      colorNormal: "#000000",
      alphaNormal: 100,
      colorText: "#ffffff",
      alphaText: 100,
      colorAuthor: "#ffd8f8",
      alphaAuthor: 100,
      fontSize: 22,
      fontBold: true,
      shadowEnabled: true,
      colorShadow: "#000000",
      alphaShadow: 90,
      colorMembership: "#1e7d32",
      alphaMembership: 100
    };

    const colorInputs = {
      fontFamily: document.getElementById("fontFamily"),
      colorNormal: document.getElementById("colorNormal"),
      alphaNormal: document.getElementById("alphaNormal"),
      colorText: document.getElementById("colorText"),
      alphaText: document.getElementById("alphaText"),
      colorAuthor: document.getElementById("colorAuthor"),
      alphaAuthor: document.getElementById("alphaAuthor"),
      fontSize: document.getElementById("fontSize"),
      fontBold: document.getElementById("fontBold"),
      shadowEnabled: document.getElementById("shadowEnabled"),
      colorShadow: document.getElementById("colorShadow"),
      alphaShadow: document.getElementById("alphaShadow"),
      colorMembership: document.getElementById("colorMembership"),
      alphaMembership: document.getElementById("alphaMembership")
    };

    function updateAlphaDisplay() {
      const alphaKeys = ["alphaNormal", "alphaText", "alphaAuthor", "alphaShadow", "alphaMembership"];
      for (const key of alphaKeys) {
        const valEl = document.getElementById(key + "Val");
        if (valEl && colorInputs[key]) {
          valEl.textContent = colorInputs[key].value + "%";
        }
      }
    }

    function loadColorSettings() {
      const saved = localStorage.getItem(COLOR_KEY);
      const colors = saved ? JSON.parse(saved) : defaultColors;
      for (const key in colorInputs) {
        if (colorInputs[key].type === "checkbox") {
          colorInputs[key].checked = colors[key] ?? defaultColors[key];
        } else {
          colorInputs[key].value = colors[key] ?? defaultColors[key];
        }
      }
      updateAlphaDisplay();
    }

    function saveColorSettings() {
      const colors = {};
      for (const key in colorInputs) {
        if (colorInputs[key].type === "checkbox") {
          colors[key] = colorInputs[key].checked;
        } else {
          colors[key] = colorInputs[key].value;
        }
      }
      localStorage.setItem(COLOR_KEY, JSON.stringify(colors));
      updateAlphaDisplay();
      // ãƒ¡ã‚¤ãƒ³ãƒ—ãƒ­ã‚»ã‚¹çµŒç”±ã§ã‚µãƒ¼ãƒãƒ¼ã«é€šçŸ¥
      ipcRenderer.send("colors:update", colors);
    }

    // å„ã‚«ãƒ©ãƒ¼å…¥åŠ›ã®å¤‰æ›´ã‚’ç›£è¦–
    for (const key in colorInputs) {
      colorInputs[key].addEventListener("input", saveColorSettings);
      colorInputs[key].addEventListener("change", saveColorSettings);
    }

    document.getElementById("btnResetColors").addEventListener("click", () => {
      for (const key in colorInputs) {
        if (colorInputs[key].type === "checkbox") {
          colorInputs[key].checked = defaultColors[key];
        } else {
          colorInputs[key].value = defaultColors[key];
        }
      }
      saveColorSettings();
    });

    // åˆæœŸèª­ã¿è¾¼ã¿
    loadColorSettings();
    // èµ·å‹•æ™‚ã«ç¾åœ¨ã®è¨­å®šã‚’ã‚µãƒ¼ãƒãƒ¼ã«é€ä¿¡
    setTimeout(() => {
      const saved = localStorage.getItem(COLOR_KEY);
      const colors = saved ? JSON.parse(saved) : defaultColors;
      ipcRenderer.send("colors:update", colors);
    }, 500);
  </script>
</body>
</html>
