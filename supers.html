<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8">
<title>Supers Only Overlay</title>
<style>
  html, body {
    margin: 0;
    padding: 0;
    background: transparent;
    overflow: hidden;
    font-family: "Yu Gothic", "Meiryo", -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
  }
  #chat {
    position: absolute;
    bottom: 10px;
    left: 10px;
    right: 10px;
    display: flex;
    flex-direction: column-reverse;
    gap: 8px;
  }

  .msg {
    display: inline-block;
    max-width: 100%;
    padding: 10px 14px;
    border-radius: 16px;

    background: rgba(0, 0, 0, 0.85);
    color: #ffffff;
    font-size: 22px;
    font-weight: 600;

    text-shadow:
      0 0 3px rgba(0,0,0,0.9),
      0 0 6px rgba(0,0,0,0.85),
      0 0 10px rgba(0,0,0,0.8);

    box-shadow: 0 0 10px rgba(0,0,0,0.7);
    animation: fadein 0.25s ease-out;
  }

  /* ギフト & メンバーシップ（緑） */
  .msg-kind-membership {
    background: #1e7d32;
    box-shadow: 0 0 14px rgba(46, 204, 113, 0.9);
  }

  .author {
    font-weight: 700;
    margin-right: 6px;
    color: #ffd8f8;
  }
  .text {
    word-break: break-word;
  }
  .text img.emoji {
    height: 1.6em;
    vertical-align: middle;
    margin: 0 2px;
  }
  .text img.sticker {
    height: 64px;
    vertical-align: middle;
    margin: 0 4px;
  }

  @keyframes fadein {
    from { opacity: 0; transform: translateY(8px); }
    to   { opacity: 1; transform: translateY(0); }
  }
</style>
</head>
<body>
<div id="chat"></div>

<script>
  const chat = document.getElementById("chat");

  let rendered = new Set();

  // Supers として扱う種類
  const allowedKinds = new Set([
    "paid",
    "sticker",
    "membership",
    "gift_purchase",
    "gift_redeem",
  ]);

  async function fetchComments() {
    try {
      const res = await fetch("/comments");
      const data = await res.json();

      data.sort((a, b) => a.timestamp_ms - b.timestamp_ms);

      for (const msg of data) {
        const kind   = msg.kind || "text";
        const amount = msg.amount || 0;
        const colors = msg.colors || null;

        // 通常チャットは表示しない
        if (!allowedKinds.has(kind)) continue;

        const id = msg.id || (msg.timestamp_ms + "_" + msg.author + "_" + msg.text);
        if (rendered.has(id)) continue;
        rendered.add(id);

        const div = document.createElement("div");
        const cls = ["msg"];

        // ギフト・メンバーシップ系は緑に固定
        if (kind === "membership" || kind === "gift_purchase" || kind === "gift_redeem") {
          cls.push("msg-kind-membership");
        }

        div.className = cls.join(" ");

        const author = document.createElement("span");
        author.className = "author";
        author.textContent = (msg.author || "？？？") + "：";

        const textSpan = document.createElement("span");
        textSpan.className = "text";

        // --- YouTube 本家色を適用 (paid / sticker 限定) ---
        if (colors && (kind === "paid" || kind === "sticker")) {

          // 背景色（body_bg）
          if (colors.body_bg) {
            div.style.backgroundColor = colors.body_bg;
            div.style.boxShadow = "0 0 15px " + colors.body_bg;
          }

          // 文字色（body_text）
          if (colors.body_text) {
            author.style.color = colors.body_text;
            textSpan.style.color = colors.body_text;

            // 文字が明るい場合はシャドウ弱める（視認性調整）
            if (colors.body_text.toUpperCase() !== "#FFFFFF") {
              author.style.textShadow = "none";
              textSpan.style.textShadow = "none";
            }
          }
        }

        // parts を HTML に組み立て
        if (msg.parts && Array.isArray(msg.parts)) {
          for (const part of msg.parts) {
            if (part.type === "text") {
              textSpan.append(document.createTextNode(part.text || ""));
            } else if (part.type === "emoji") {
              const img = document.createElement("img");
              img.className = "emoji";
              img.src = part.url;
              img.alt = part.alt || "";
              textSpan.append(img);
            } else if (part.type === "sticker") {
              const img = document.createElement("img");
              img.className = "sticker";
              img.src = part.url;
              img.alt = part.alt || "";
              textSpan.append(img);
            }
          }
        } else {
          textSpan.textContent = msg.text || "";
        }

        div.appendChild(author);
        div.appendChild(textSpan);

        chat.prepend(div);

        if (chat.children.length > 50) {
          chat.removeChild(chat.children[chat.children.length - 1]);
        }
      }
    } catch (e) {
      console.error("fetchComments error", e);
    }
  }

  setInterval(fetchComments, 500);
  fetchComments();
</script>
</body>
</html>