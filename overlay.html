<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8">
<title>Comment Overlay</title>
<!-- Google Fonts -->
<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=BIZ+UDGothic&family=Hachi+Maru+Pop&family=Klee+One&family=Kosugi+Maru&family=M+PLUS+1p:wght@400;700&family=M+PLUS+Rounded+1c:wght@400;700&family=Noto+Sans+JP:wght@400;700&family=Yusei+Magic&family=Zen+Maru+Gothic:wght@400;700&display=swap" rel="stylesheet">
<style>
  html, body {
    margin: 0;
    padding: 0;
    background: transparent; /* OBSで透過させる */
    overflow: hidden;
    font-family: var(--font-family, "Yu Gothic", "Meiryo", -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif);
  }
  #chat {
    position: absolute;
    bottom: 10px;
    left: 10px;
    right: 10px;
    display: flex;
    flex-direction: column-reverse; /* 下から積み上げる */
    gap: 8px;
  }

  /* 基本スタイル（通常コメント） */
  .msg {
    display: inline-block;
    max-width: 100%;
    padding: 10px 14px;
    border-radius: 16px;

    background: var(--color-normal, rgba(0, 0, 0, 1)); /* デフォ黒 */

    color: var(--color-text, #ffffff);
    font-size: var(--font-size, 22px);
    font-weight: var(--font-weight, 600);
    text-shadow: var(--text-shadow, 0 0 3px rgba(0,0,0,0.9), 0 0 6px rgba(0,0,0,0.85), 0 0 10px rgba(0,0,0,0.8));

    box-shadow: 0 0 10px rgba(0,0,0,0.7);

    animation: fadein 0.25s ease-out;
  }

  /* ギフト & マイルストーン系（緑） */
  .msg-kind-membership,
  .msg-kind-gift_purchase,
  .msg-kind-gift_redeem {
    background: var(--color-membership, #1e7d32); /* 濃いめグリーン */
    box-shadow: 0 0 14px rgba(46, 204, 113, 0.9);
  }

  /* スパチャ/ステッカー 金額帯別カラー */

  /* 小額 (〜499) ブルーっぽい */
  .msg-paid-tier1 {
    background: var(--color-tier1, #1565c0);
    box-shadow: 0 0 14px rgba(21, 101, 192, 0.9);
  }

  /* 中額 (500〜1999) シアン〜グリーン */
  .msg-paid-tier2 {
    background: var(--color-tier2, #00897b);
    box-shadow: 0 0 14px rgba(0, 137, 123, 0.9);
  }

  /* 高額 (2000〜9999) イエロー〜オレンジ */
  .msg-paid-tier3 {
    background: var(--color-tier3, #f9a825);
    box-shadow: 0 0 16px rgba(249, 168, 37, 0.95);
    color: #111;
    text-shadow:
      0 0 3px rgba(255,255,255,0.7),
      0 0 6px rgba(255,255,255,0.7);
  }

  /* 超高額 (10000〜) レッド〜ピンク */
  .msg-paid-tier4 {
    background: var(--color-tier4, #c2185b);
    box-shadow: 0 0 18px rgba(194, 24, 91, 0.98);
  }

  .author {
    font-weight: 700;
    margin-right: 6px;
    color: var(--color-author, #ffd8f8); /* かわいいピンク */
    text-shadow: var(--text-shadow, 0 0 3px rgba(0,0,0,0.9), 0 0 6px rgba(0,0,0,0.85), 0 0 10px rgba(0,0,0,0.8));
  }
  .text {
    word-break: break-word;
  }
  .text img.emoji {
    height: 1.6em;
    vertical-align: middle;
    margin: 0 2px;
  }
  .text img.sticker {
    height: 64px;
    vertical-align: middle;
    margin: 0 4px;
  }
  @keyframes fadein {
    from { opacity: 0; transform: translateY(8px); }
    to   { opacity: 1; transform: translateY(0); }
  }
</style>
</head>
<body>
<div id="chat"></div>

<script>
  const chat = document.getElementById("chat");

  // すでに表示済みのコメントID
  let rendered = new Set();

  // 設定を取得して適用
  async function fetchAndApplySettings() {
    try {
      const res = await fetch("/settings/colors");
      const colors = await res.json();
      const root = document.documentElement;
      
      // hex色をrgbaに変換するヘルパー
      function hexToRgba(hex, alpha) {
        const r = parseInt(hex.slice(1, 3), 16);
        const g = parseInt(hex.slice(3, 5), 16);
        const b = parseInt(hex.slice(5, 7), 16);
        return `rgba(${r}, ${g}, ${b}, ${alpha / 100})`;
      }

      root.style.setProperty("--color-normal", hexToRgba(colors.colorNormal || "#000000", colors.alphaNormal ?? 100));
      root.style.setProperty("--font-family", `"${colors.fontFamily || 'Noto Sans JP'}", "Yu Gothic", "Meiryo", sans-serif`);
      root.style.setProperty("--color-text", hexToRgba(colors.colorText || "#ffffff", colors.alphaText ?? 100));
      root.style.setProperty("--color-author", hexToRgba(colors.colorAuthor || "#ffd8f8", colors.alphaAuthor ?? 100));
      root.style.setProperty("--font-size", (colors.fontSize || 22) + "px");
      root.style.setProperty("--font-weight", colors.fontBold !== false ? "600" : "400");
      
      // シャドウのオンオフ
      const shadowEnabled = colors.shadowEnabled !== false;
      const shadowAlpha = colors.alphaShadow ?? 90;
      const shadowColor = colors.colorShadow || "#000000";
      if (shadowEnabled) {
        root.style.setProperty("--text-shadow", `0 0 3px ${hexToRgba(shadowColor, shadowAlpha)}, 0 0 6px ${hexToRgba(shadowColor, shadowAlpha * 0.9)}, 0 0 10px ${hexToRgba(shadowColor, shadowAlpha * 0.8)}`);
      } else {
        root.style.setProperty("--text-shadow", "none");
      }

      root.style.setProperty("--color-membership", hexToRgba(colors.colorMembership || "#1e7d32", colors.alphaMembership ?? 100));
    } catch (e) {
      console.error("fetchAndApplySettings error", e);
    }
  }

  async function fetchComments() {
    try {
      const res = await fetch("/comments");
      const data = await res.json();

      // timestamp_ms 昇順でソート
      data.sort((a, b) => a.timestamp_ms - b.timestamp_ms);

      for (const msg of data) {
        const baseId = msg.id || (msg.timestamp_ms + "_" + (msg.author || "") + "_" + (msg.text || ""));
        const id = String(baseId);

        // すでに描画済みならスキップ
        if (rendered.has(id)) continue;
        rendered.add(id);

        const div = document.createElement("div");

        // --- 種類・金額からクラス決定 ---
        const cls = ["msg"];

        const kind = msg.kind || "text";
        const amount = msg.amount || 0;

        if (kind === "membership" || kind === "gift_purchase" || kind === "gift_redeem") {
          cls.push("msg-kind-membership");
        } else if (kind === "paid" || kind === "sticker") {
          if (amount >= 10000) {
            cls.push("msg-paid-tier4");
          } else if (amount >= 2000) {
            cls.push("msg-paid-tier3");
          } else if (amount >= 500) {
            cls.push("msg-paid-tier2");
          } else {
            cls.push("msg-paid-tier1");
          }
        }

        div.className = cls.join(" ");

        const author = document.createElement("span");
        author.className = "author";
        author.textContent = (msg.author || "？？？") + "：";

        const textSpan = document.createElement("span");
        textSpan.className = "text";

        // parts があれば、parts を使ってテキスト & 絵文字 & スタンプを構成
        if (msg.parts && Array.isArray(msg.parts) && msg.parts.length > 0) {
          for (const part of msg.parts) {
            if (part.type === "text") {
              textSpan.append(document.createTextNode(part.text || ""));
            } else if (part.type === "emoji") {
              const img = document.createElement("img");
              img.className = "emoji";
              img.src = part.url;
              img.alt = part.alt || "";
              textSpan.append(img);
            } else if (part.type === "sticker") {
              const img = document.createElement("img");
              img.className = "sticker";
              img.src = part.url;
              img.alt = part.alt || "";
              textSpan.append(img);
            }
          }
        } else {
          // parts が無い場合は text だけ表示（互換用）
          textSpan.textContent = msg.text || "";
        }

        div.appendChild(author);
        div.appendChild(textSpan);

        // 下に追加
        chat.prepend(div);

        // 表示件数が多すぎる場合は古いものを削除
        if (chat.children.length > 50) {
          chat.removeChild(chat.children[chat.children.length - 1]);
        }
      }

    } catch (e) {
      console.error("fetchComments error", e);
    }
  }

  // 0.5秒ごとにポーリング
  setInterval(fetchComments, 500);
  fetchComments();

  // 設定を定期的に取得（2秒ごと）
  setInterval(fetchAndApplySettings, 2000);
  fetchAndApplySettings();
</script>
</body>
</html>