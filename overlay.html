<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8">
<title>Comment Overlay</title>
<style>
  html, body {
    margin: 0;
    padding: 0;
    background: transparent; /* OBSで透過させる */
    overflow: hidden;
    font-family: "Yu Gothic", "Meiryo", -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
  }
  #chat {
    position: absolute;
    bottom: 10px;
    left: 10px;
    right: 10px;
    display: flex;
    flex-direction: column-reverse; /* 下から積み上げる */
    gap: 8px;
  }

  /* 基本スタイル（通常コメント） */
  .msg {
    display: inline-block;
    max-width: 100%;
    padding: 10px 14px;
    border-radius: 16px;

    background: rgba(0, 0, 0, 1); /* デフォ黒 */

    color: #ffffff;
    font-size: 22px;
    font-weight: 600;
    text-shadow:
      0 0 3px rgba(0,0,0,0.9),
      0 0 6px rgba(0,0,0,0.85),
      0 0 10px rgba(0,0,0,0.8);

    box-shadow: 0 0 10px rgba(0,0,0,0.7);

    animation: fadein 0.25s ease-out;
  }

  /* ギフト & マイルストーン系（緑） */
  .msg-kind-membership,
  .msg-kind-gift_purchase,
  .msg-kind-gift_redeem {
    background: #1e7d32; /* 濃いめグリーン */
    box-shadow: 0 0 14px rgba(46, 204, 113, 0.9);
  }

  /* スパチャ/ステッカー 金額帯別カラー */

  /* 小額 (〜499) ブルーっぽい */
  .msg-paid-tier1 {
    background: #1565c0;
    box-shadow: 0 0 14px rgba(21, 101, 192, 0.9);
  }

  /* 中額 (500〜1999) シアン〜グリーン */
  .msg-paid-tier2 {
    background: #00897b;
    box-shadow: 0 0 14px rgba(0, 137, 123, 0.9);
  }

  /* 高額 (2000〜9999) イエロー〜オレンジ */
  .msg-paid-tier3 {
    background: #f9a825;
    box-shadow: 0 0 16px rgba(249, 168, 37, 0.95);
    color: #111;
    text-shadow:
      0 0 3px rgba(255,255,255,0.7),
      0 0 6px rgba(255,255,255,0.7);
  }

  /* 超高額 (10000〜) レッド〜ピンク */
  .msg-paid-tier4 {
    background: #c2185b;
    box-shadow: 0 0 18px rgba(194, 24, 91, 0.98);
  }

  .author {
    font-weight: 700;
    margin-right: 6px;
    color: #ffd8f8; /* かわいいピンク */
    text-shadow:
      0 0 3px rgba(0,0,0,0.9),
      0 0 6px rgba(0,0,0,0.85),
      0 0 10px rgba(0,0,0,0.8);
  }
  .text {
    word-break: break-word;
  }
  .text img.emoji {
    height: 1.6em;
    vertical-align: middle;
    margin: 0 2px;
  }
  .text img.sticker {
    height: 64px;
    vertical-align: middle;
    margin: 0 4px;
  }
  @keyframes fadein {
    from { opacity: 0; transform: translateY(8px); }
    to   { opacity: 1; transform: translateY(0); }
  }
</style>
</head>
<body>
<div id="chat"></div>

<script>
  const chat = document.getElementById("chat");

  // すでに表示済みのコメントID
  let rendered = new Set();

  async function fetchComments() {
    try {
      const res = await fetch("/comments");
      const data = await res.json();

      // timestamp_ms 昇順でソート
      data.sort((a, b) => a.timestamp_ms - b.timestamp_ms);

      for (const msg of data) {
        const baseId = msg.id || (msg.timestamp_ms + "_" + (msg.author || "") + "_" + (msg.text || ""));
        const id = String(baseId);

        // すでに描画済みならスキップ
        if (rendered.has(id)) continue;
        rendered.add(id);

        const div = document.createElement("div");

        // --- 種類・金額からクラス決定 ---
        const cls = ["msg"];

        const kind = msg.kind || "text";
        const amount = msg.amount || 0;

        if (kind === "membership" || kind === "gift_purchase" || kind === "gift_redeem") {
          cls.push("msg-kind-membership");
        } else if (kind === "paid" || kind === "sticker") {
          if (amount >= 10000) {
            cls.push("msg-paid-tier4");
          } else if (amount >= 2000) {
            cls.push("msg-paid-tier3");
          } else if (amount >= 500) {
            cls.push("msg-paid-tier2");
          } else {
            cls.push("msg-paid-tier1");
          }
        }

        div.className = cls.join(" ");

        const author = document.createElement("span");
        author.className = "author";
        author.textContent = (msg.author || "？？？") + "：";

        const textSpan = document.createElement("span");
        textSpan.className = "text";

        // parts があれば、parts を使ってテキスト & 絵文字 & スタンプを構成
        if (msg.parts && Array.isArray(msg.parts) && msg.parts.length > 0) {
          for (const part of msg.parts) {
            if (part.type === "text") {
              textSpan.append(document.createTextNode(part.text || ""));
            } else if (part.type === "emoji") {
              const img = document.createElement("img");
              img.className = "emoji";
              img.src = part.url;
              img.alt = part.alt || "";
              textSpan.append(img);
            } else if (part.type === "sticker") {
              const img = document.createElement("img");
              img.className = "sticker";
              img.src = part.url;
              img.alt = part.alt || "";
              textSpan.append(img);
            }
          }
        } else {
          // parts が無い場合は text だけ表示（互換用）
          textSpan.textContent = msg.text || "";
        }

        div.appendChild(author);
        div.appendChild(textSpan);

        // 下に追加
        chat.prepend(div);

        // 表示件数が多すぎる場合は古いものを削除
        if (chat.children.length > 50) {
          chat.removeChild(chat.children[chat.children.length - 1]);
        }
      }

    } catch (e) {
      console.error("fetchComments error", e);
    }
  }

  // 0.5秒ごとにポーリング
  setInterval(fetchComments, 500);
  fetchComments();
</script>
</body>
</html>